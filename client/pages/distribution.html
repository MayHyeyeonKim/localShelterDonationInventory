<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/style.css">
    <title>Donation Distribution Form</title>
</head>
<body>
    <h1>Donation Distribution Form</h1>
    <nav>
        <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/donation.html">Donation</a></li>
            <li><a href="/distribution.html">Distribution</a></li>
            <li id="loginNav"><a href="/login.html">Login</a></li>
            <li id="signupNav"><a href="/Signup.html">Signup</a></li>
            <li id="logoutNav" style="display: none;"><a href="/logout">Logout</a></li>
        </ul>
    </nav>

    <form id="distributionForm">
        <label for="distributionDate">Distribution Date:</label>
        <input type="date" id="distributionDate" name="distributionDate" required><br>

        <label for="distributionLocation">Distribution Location:</label>
        <input type="text" id="distributionLocation" name="distributionLocation" required><br>

        <label for="donationType">Donation Type:</label>
        <input type="text" id="donationType" name="donationType" required><br>

        <label for="quantity">Quantity:</label>
        <input type="number" id="quantity" name="quantity" required><br>

        <label for="amount">Amount:</label>
        <input type="number" id="amount" name="amount" required><br>

        <button type="button" onclick="logDonationDistribution()">Log Donation Distribution</button>

        <script>
            // 사용자가 로그인되어 있는지 확인하는 함수 (이 함수는 애플리케이션에 맞게 구현되어야 합니다)
            async function checkAuthentication() {
                try {
                    const response = await fetch('http://localhost:3000/checkAuthentication', {
                        method: 'GET',
                        credentials: 'include', // Include credentials (cookies) in the request
                    });

                    if (response.ok) {
                        // 사용자가 로그인되어 있으면 계속 진행
                        return true;
                    } else {
                        // 사용자가 로그인되어 있지 않으면 로그인 페이지로 리디렉션
                        window.location.href = '/login'; // Redirect to your login page
                        return false;
                    }
                } catch (error) {
                    console.error('Error checking authentication:', error);
                    // 에러 발생 시 로그인 페이지로 리디렉션
                    window.location.href = '/login';
                    return false;
                }
            }

            async function logDonationDistribution() {
                // 사용자가 로그인되어 있는지 확인
                const isAuthenticated = await checkAuthentication();

                if (isAuthenticated) {
                    // 로그인되어 있으면 Donation Distribution 로깅 로직 계속 진행
                    const distributionDate = document.getElementById('distributionDate').value;
                    const distributionLocation = document.getElementById('distributionLocation').value;
                    const donationType = document.getElementById('donationType').value;
                    const quantity = document.getElementById('quantity').value;
                    const amount = document.getElementById('amount').value;

                    try {
                        const response = await fetch('http://localhost:3000/distributions/submitDistribution', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                distributionDate,
                                distributionLocation,
                                donationType,
                                quantity,
                                amount,
                            }),
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert(`Donation Distribution logged successfully!\n${JSON.stringify(result.distribution)}`);
                        } else {
                            alert('Failed to log Donation Distribution.');
                        }
                    } catch (error) {
                        console.error('Error logging Donation Distribution:', error);
                        alert('Internal Server Error');
                    }
                }
                // 사용자가 로그인되어 있지 않으면 함수 종료
            }
        </script>
    </form>

    <footer>
        <p>&copy; 2024 Your Website Name</p>
    </footer>
</body>
</html>